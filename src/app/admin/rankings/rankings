'use client'
import { useEffect, useState } from 'react'
import Link from 'next/link'
import { ArrowLeft, Trophy, Shield, AlertTriangle, Loader2, Printer, Lock } from 'lucide-react'

async function safeJson(res) {
  try { return await res.json() } catch { return {} }
}

export default function AdminRankings() {
  const [pin, setPin] = useState('')
  const [authed, setAuthed] = useState(false)
  const [loading, setLoading] = useState(false)

  const [etapas, setEtapas] = useState([])
  const [etapaId, setEtapaId] = useState('')
  const [data, setData] = useState(null)

  function auth() {
    if (pin === '2026') setAuthed(true)
    else alert('PIN incorreto')
  }

  async function loadEtapas() {
    // Busca etapas sem cache para garantir lista atualizada
    const res = await fetch('/api/admin/etapas', { 
        headers: { 'x-admin-pin': pin },
        cache: 'no-store' 
    })
    const et = await safeJson(res)
    setEtapas(Array.isArray(et) ? et : [])
  }

  async function loadRankings(id) {
    setLoading(true)
    try {
      const res = await fetch(`/api/admin/rankings?etapa_id=${id}`, { 
          headers: { 'x-admin-pin': pin },
          cache: 'no-store'
      })
      const d = await safeJson(res)
      if (!res.ok) return alert(d?.error || 'Erro ao carregar rankings')
      setData(d)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    if (authed) loadEtapas()
  }, [authed])

  useEffect(() => {
    if (authed && etapaId) loadRankings(etapaId)
  }, [etapaId])

  if (!authed) {
    return (
      <main className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
        <div className="bg-slate-900 p-10 rounded-2xl border border-slate-800 text-center max-w-sm w-full shadow-2xl">
          <div className="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_20px_rgba(37,99,235,0.5)]">
            <Lock className="text-white" size={32}/>
          </div>
          <h1 className="text-2xl font-black text-white uppercase mb-6 tracking-widest">Relat√≥rios</h1>
          <input
            type="password"
            placeholder="PIN DE SEGURAN√áA"
            className="w-full p-4 bg-slate-950 border border-slate-800 rounded-xl text-center text-white font-bold text-xl mb-6 tracking-[0.5em] outline-none focus:border-blue-600 transition-colors"
            value={pin}
            onChange={(e) => setPin(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && auth()}
          />
          <button onClick={auth} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl uppercase hover:bg-blue-500 transition-all">
            Acessar Dados
          </button>
          <Link href="/admin" className="block mt-6 text-xs font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">
            ‚Üê Voltar ao Painel
          </Link>
        </div>
      </main>
    )
  }

  return (
    <main className="min-h-screen bg-slate-50 py-10 px-4 md:px-10 font-sans text-slate-800">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-8 print:hidden">
          <Link href="/admin" className="flex items-center gap-2 text-slate-500 hover:text-blue-600 font-bold text-sm uppercase transition-colors">
            <ArrowLeft size={18} /> Voltar ao Painel
          </Link>
          <div className="flex items-center gap-4">
             <button onClick={() => window.print()} className="bg-white border border-slate-200 text-slate-600 p-2 rounded-lg hover:text-blue-600 transition-colors" title="Imprimir Relat√≥rio">
                <Printer size={20}/>
             </button>
             <h1 className="text-2xl font-black uppercase italic tracking-tighter text-slate-900">
                Relat√≥rios Oficiais
             </h1>
          </div>
        </div>

        <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm p-6 mb-8 print:hidden">
          <div className="flex flex-col md:flex-row gap-4 items-end">
            <div className="flex-1 w-full">
                <label className="text-[10px] font-black uppercase text-slate-400 mb-2 block tracking-widest">Selecionar Campeonato / Etapa</label>
                <select
                  className="w-full p-4 rounded-xl border border-slate-200 bg-slate-50 font-bold text-sm outline-none focus:border-blue-500 transition-colors"
                  value={etapaId}
                  onChange={(e) => setEtapaId(e.target.value)}
                >
                  <option value="">‚Äî Selecione para carregar ‚Äî</option>
                  {etapas.map((e) => (
                    <option key={e.id} value={e.id}>
                      {e.status === 'EM_ANDAMENTO' ? 'üü¢' : '‚ö´'} {e.titulo} ({e.modalidade})
                    </option>
                  ))}
                </select>
            </div>
            <button
              onClick={() => etapaId && loadRankings(etapaId)}
              className="bg-slate-900 text-white font-black rounded-xl px-8 py-4 uppercase text-xs hover:bg-blue-600 transition-all shadow-lg"
            >
              Atualizar Dados
            </button>
          </div>
        </div>

        {loading ? (
          <div className="p-20 flex flex-col items-center justify-center gap-4 text-slate-400 font-bold">
            <Loader2 className="animate-spin text-blue-600" size={48} />
            <p className="text-xs uppercase tracking-widest">Calculando estat√≠sticas...</p>
          </div>
        ) : !data ? (
          <div className="p-20 text-center text-slate-400 font-bold bg-white rounded-[2rem] border border-dashed border-slate-300">
            Selecione uma etapa acima para visualizar os rankings t√©cnicos.
          </div>
        ) : (
          <div className="grid lg:grid-cols-3 gap-8">
            
            {/* ARTILHARIA */}
            <Card title="Artilharia (Gols Pr√≥)" icon={<Trophy size={18} className="text-yellow-500" />} headerColor="bg-slate-900 text-white">
              {(data.artilharia || []).length === 0 ? (
                <Empty />
              ) : (
                <List>
                  {data.artilharia.map((a, i) => (
                    <Row
                      key={a.atleta_id}
                      rank={i + 1}
                      left={
                        <div>
                            <span className="font-black text-slate-900 text-sm uppercase">{a.atleta_nome}</span>
                            <span className="text-[10px] font-bold text-slate-400 block mt-0.5">Camisa #{a.camisa_cadastro ?? '?'} ‚Ä¢ {a.nome_equipe}</span>
                        </div>
                      }
                      right={<span className="text-lg font-black text-yellow-600 bg-yellow-50 px-3 py-1 rounded-lg border border-yellow-100">{a.gols}</span>}
                    />
                  ))}
                </List>
              )}
            </Card>

            {/* MELHOR DEFESA */}
            <Card title="Melhor Defesa (Goleiro)" icon={<Shield size={18} className="text-blue-500" />} headerColor="bg-white border-b border-slate-100 text-slate-900">
              {(data.menosVazado || []).length === 0 ? (
                <Empty />
              ) : (
                <List>
                  {data.menosVazado.map((t, i) => (
                    <Row
                      key={t.equipe_id}
                      rank={i + 1}
                      left={
                        <div>
                            <span className="font-black text-slate-900 text-sm uppercase">{t.nome_equipe}</span>
                            <span className="text-[10px] font-bold text-slate-400 block mt-0.5">Jogos: {t.j} ‚Ä¢ Saldo: {t.sg}</span>
                        </div>
                      }
                      right={
                        <div className="text-right">
                            <span className="text-lg font-black text-blue-600 block leading-none">{t.gc}</span>
                            <span className="text-[8px] font-bold text-slate-400 uppercase">Gols</span>
                        </div>
                      }
                    />
                  ))}
                </List>
              )}
            </Card>

            {/* DISCIPLINA (FAIR PLAY) */}
            <Card title="Controle Disciplinar" icon={<AlertTriangle size={18} className="text-red-500" />} headerColor="bg-white border-b border-slate-100 text-slate-900">
              {(data.disciplina || []).length === 0 ? (
                <Empty />
              ) : (
                <List>
                  {data.disciplina.map((d, i) => (
                    <Row
                      key={d.atleta_id}
                      rank={i + 1}
                      left={
                        <div>
                            <span className="font-bold text-slate-700 text-xs uppercase">{d.atleta_nome}</span>
                            <span className="text-[9px] font-bold text-slate-400 block mt-0.5">{d.nome_equipe}</span>
                        </div>
                      }
                      right={
                        <div className="flex gap-2">
                            {d.vermelhos > 0 && <span className="bg-red-100 text-red-700 border border-red-200 px-2 py-0.5 rounded text-[10px] font-black" title="Cart√µes Vermelhos">{d.vermelhos} CV</span>}
                            {d.amarelos > 0 && <span className="bg-yellow-100 text-yellow-700 border border-yellow-200 px-2 py-0.5 rounded text-[10px] font-black" title="Cart√µes Amarelos">{d.amarelos} CA</span>}
                        </div>
                      }
                    />
                  ))}
                </List>
              )}
            </Card>
          </div>
        )}
      </div>
    </main>
  )
}

function Card({ title, icon, children, headerColor }) {
  return (
    <div className="bg-white rounded-[2rem] border border-slate-200 shadow-xl overflow-hidden flex flex-col h-full">
      <div className={`p-6 flex items-center gap-3 ${headerColor}`}>
        {icon}
        <h2 className="font-black uppercase tracking-widest text-xs">{title}</h2>
      </div>
      <div className="p-6 flex-1 bg-slate-50/50">
        {children}
      </div>
    </div>
  )
}

function List({ children }) {
  return <div className="space-y-3">{children}</div>
}

function Row({ rank, left, right }) {
  return (
    <div className="bg-white border border-slate-100 rounded-xl p-3 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow">
      <div className="flex items-center gap-3">
        <span className={`text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full ${rank <= 3 ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400'}`}>
            {rank}
        </span>
        {left}
      </div>
      {right}
    </div>
  )
}

function Empty() {
  return (
    <div className="h-32 flex items-center justify-center border-2 border-dashed border-slate-200 rounded-xl">
        <p className="text-slate-400 font-bold text-xs uppercase tracking-widest">Sem dados registrados</p>
    </div>
  )
}